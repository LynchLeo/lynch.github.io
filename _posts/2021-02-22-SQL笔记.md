---
layout:     post
title:      SQL笔记
subtitle:   语句
date:       2021-02-22
author:     LynchLeo
header-img: img/post-web.jpg
catalog: true
tags:
    - SQL
---

[https://www.db-book.com/db7/university-lab-dir/sqljs.html](https://www.db-book.com/db7/university-lab-dir/sqljs.html)

# Introduction

## Data

* Three levels of data abstraction
  * Physical level focuses on the actual format and location of data
  * Logical level focuses on the meaning, content, and context of the data
  * View level focuses on simplifying the interaction with the system

* Logic view – data is organized into groups or categories
  * Character – single letter, number, or special character
  * Field – group of related characters
  * Record – collection of related fields
  * Table – collection of related records
  * Database – integrated collection of logically related tables

* Key Field or Primary Key (the “Unique identifier”)
  * Used to create relationships between tables

* Batch versus Real-Time Processing
  * In batch processing, data is collected over several hours, days, or even weeks. It is then processed all at once as a “batch.”
  * In real-time processing, also known as online processing, data is processed at the same time the transaction occurs. 

## Database

* Collection of integrated data
  * Logically related files and records

* Databases address
  * data redundancy – same information in multiple files
  * data integrity – accurate updating of files

* Advantages to having databases
  * Sharing – between departments of an organization
  * Security – limited access
  * Less data redundancy – decrease unnecessary duplication
  * Data integrity – reduce the likelihood of inaccurate data

## Database Management System (DBMS)

* A database management system (DBMS) is the software for creating, modifying, and gaining access to the database.
* A DBMS consists of five subsystems:
  * DBMS engine provides a bridge between logical and physical data views.
  * Data definition subsystem defines the logical structure of a database using a data dictionary or schema.
  * Data manipulation subsystem provides tools for data maintenance and data analysis;
    * tools include query-by-example and structured query language (SQL).
  * Application generation subsystem provides tools for creating data entry forms with specialized programming languages.
  * Data administration subsystem manages the database;
    * database administrators (DBAs) are computer professionals who help define processing rights and access rights of data in the database.

## Common Database Models

* Hierarchical database
  * Fields or records structured in nodes
    * Nodes - points connected like branches of an upsidedown tree
    * One parent per node
    * Parent can have several child nodes
      * One-to-many relationship
  * Major concern is that if your parent node is deleted then so are all subordinate child nodes

* Network database
  * Hierarchical node arrangement
    * Each child node may have more than one parent node
      * Many-to-many relationship
  * Additional connections between parent and child are Pointers
  * Nodes can be reached through multiple paths

* Relational database
  * A more flexible type where there are no access paths down a hierarchy
    * Data stored in table called a relation
    * Tables consist of rows and columns
    * Tables related via a common data item / key field

* Multidimensional database
  * A variation and an extension of the relational model
  * Includes a data cube
    * Extension of the two-dimensional data model to include additional or multiple dimensions
  * Good for representing complex relationships
  * Advantages over relational databases
    * Conceptualization provides users with an intuitive model in which complex data and relationships can be conceptualized
    * Processing speed for analyzing and querying a large multidimensional database is faster

* Object-oriented database
  * Store data as well as instructions to manipulate data
  * Organize data using
    * Classes – general definitions
    * Objects – specific instances of class containing data and instructions to manipulate the data
    * Attributes – data fields an object possesses
    * Methods – instructions for retrieving or manipulating attribute values

## Types of Databases

* Individual or Persona Computer Database
  * Integrated files used by just one person
* Company Database
  * Common operational or commonly used files shared in an organization
* Distributed Database
  * Database spread geographically and accessed using database server
    * All the data in a database is not physically located in one place
* Commercial or Information Utilities or Data Banks
  * Enormous database that organizations develop to cover particular subjects such as
    * Dialog Information Services
    * Dow Jones Interactive Publishing
    * Lexis Nexis

## Instances and Schemas

* Like types and variables in programming languages
* Logical Schema – the overall logical structure of the database
  * Example: The database consists of information about a set of customers and accounts in a bank and the relationship between them
    * Analogous to type information of a variable in a program
* Physical schema – the overall physical structure of the database
* Instance – the actual content of the database at a particular point in time
  * Analogous to the value of a variable
* Physical Data Independence – the ability to modify the physical schema without changing the logical schema
  * Applications depend on the logical schema
  * In general, the interfaces between the various levels and components should be well defined so that changes in some parts do not seriously influence others

## Data Definition Language (DDL)

* Specification notation for defining the database schema

    Example: 
```sql
        create table instructor (
               ID          char(5),
               name        varchar(20),
               dept_name   varchar(20),
               salary      numeric(8,2))
```

* DDL compiler generates a set of table templates stored in a data dictionary
* Data dictionary contains metadata (i.e., data about data)
  * Database schema
  * Integrity constraints
    * Primary key (ID uniquely identifies instructors)
  * Authorization
    * Who can access what

## Data Manipulation Language (DML)

* Language for accessing and updating the data organized by the appropriate data model
  * DML also known as query language
* There are basically two types of data-manipulation language
  * Procedural DML -- require a user to specify what data are needed and how to get those data.
  * Declarative DML -- require a user to specify what data are needed without specifying how to get those data.
* Declarative DMLs are usually easier to learn and use than are procedural DMLs.
* Declarative DMLs are also referred to as non-procedural DMLs
* The portion of a DML that involves information retrieval is called a query language. 

## SQL Query Language

* SQL query language is nonprocedural. A query takes as input several tables (possibly only one) and always returns a single table.
* Example to find all instructors in Comp. Sci. dept
```sql
    select name
    from instructor
    where dept_name = 'Comp. Sci.'
```
* SQL is NOT a Turing machine equivalent language
* To be able to compute complex functions SQL is usually embedded in some higher-level language
* Application programs generally access databases through one of
  * Language extensions to allow embedded SQL
  * Application program interface (e.g., ODBC/JDBC) which allow SQL queries to be sent to a database

## Database Design

The process of designing the general structure of the database:
* Logical Design – Deciding on the database schema. Database design requires that we find a “good” collection of relation schemas.
  * Business decision – What attributes should we record in the database?
  * Computer Science decision – What relation schemas should we have and how should the attributes be distributed among the various relation schemas?
* Physical Design – Deciding on the physical layout of the database

## Database Engine

* A database system is partitioned into modules that deal with each of the responsibilities of the overall system.
* The functional components of a database system can be divided into
  * The storage manager,
  * The query processor component,
  * The transaction management component.

## Storage Manager

* A program module that provides the interface between the low-level data stored in the database and the application programs and queries submitted to the system.
* The storage manager is responsible to the following tasks:
  * Interaction with the OS file manager
  * Efficient storing, retrieving and updating of data
* The storage manager components include:
  * Authorization and integrity manager
  * Transaction manager
  * File manager
  * Buffer manager
* The storage manager implements several data structures as part of the physical system implementation:
  * Data files -- store the database itself
  * Data dictionary -- stores metadata about the structure of the database, in particular the schema of the database.
  * Indices -- can provide fast access to data items. A database index provides pointers to those data items that hold a particular value. 

## Query Processor

* The query processor components include:
  * DDL interpreter -- interprets DDL statements and records the definitions in the data dictionary.
  * DML compiler -- translates DML statements in a query language into an evaluation plan consisting of low-level instructions that the query evaluation engine understands.
    * The DML compiler performs query optimization; that is, it picks the lowest cost evaluation plan from among the various alternatives.
  * Query evaluation engine -- executes low-level instructions generated by the DML compiler.

## Transaction Management

* A transaction is a collection of operations that performs a single logical function in a database application.
  * Transaction-management component ensures that the database remains in a consistent (correct) state despite system failures (e.g., power failures and operating system crashes) and transaction failures.
  * Concurrency-control manager controls the interaction among the concurrent transactions, to ensure the consistency of the database.
* The database system maintains the often-called ACID properties:
  * Atomicity. Either all operations of the transaction are reflected properly in the database or none are.
  * Consistency. Execution of a transaction in isolation (that is, with no other transaction executing concurrently) preserves the consistency of the database.
  * Isolation. Even though multiple transactions may execute concurrently, the system guarantees that each transaction is unaware of other transactions executing concurrently in the system.
  * Durability. After a transaction completes successfully, the changes it has made to the database persist, even if there are system failures.

## Database Architecture

* The architecture of a database systems is greatly influenced by the underlying computer system on which the database is running:
  * Centralized databases
    * One to a few cores, shared memory
  * Client-server,
    * One server machine executes work on behalf of multiple client machines.
  * Parallel databases
    * Many cores shared memory
    * Shared disk
    * Shared nothing
  * Distributed databases
    * Geographical distribution
    * Schema/data heterogeneity

## Database Applications

Database applications are usually partitioned into two or three parts
* Two-tier architecture -- the application resides at the client machine, where it invokes database system functionality at the server machine
* Three-tier architecture -- the client machine acts as a front end and does not contain any direct database calls.
  * The client end communicates with an application server, usually through a forms interface.
  * The application server in turn communicates with a database system to access data. 

## Database Administrator

A person who has central control over the system is called a database administrator (DBA). Functions of a DBA include:
* Schema definition
* Storage structure and access-method definition
* Schema and physical-organization modification
* Granting of authorization for data access
* Routine maintenance
* Periodically backing up the database
* Ensuring that enough free disk space is available for normal operations, and upgrading disk space as required
* Monitoring jobs running on the database

## History of Database Systems

* 1950s and early 1960s:
  * Data processing using magnetic tapes for storage
    * Tapes provided only sequential access
  * Punched cards for input
* Late 1960s and 1970s:
  * Hard disks allowed direct access to data
  * Network and hierarchical data models in widespread use
  * Ted Codd defines the relational data model
    * Would win the ACM Turing Award for this work
    * IBM Research begins System R prototype
    * UC Berkeley (Michael Stonebraker) begins Ingres prototype
    * Oracle releases first commercial relational database
  * High-performance (for the era) transaction processing
* 1980s:
  * Research relational prototypes evolve into commercial systems
    * SQL becomes industrial standard
  * Parallel and distributed database systems
    * Wisconsin, IBM, Teradata
  * Object-oriented database systems
* 1990s:
  * Large decision support and data-mining applications
  * Large multi-terabyte data warehouses
  * Emergence of Web commerce
* 2000s
  * Big data storage systems
    * Google BigTable, Yahoo PNuts, Amazon,
    * “NoSQL” systems.
  * Big data analysis: beyond SQL
    * Map reduce and friends
* 2010s
  * SQL reloaded
    * SQL front end to Map Reduce systems
    * Massively parallel database systems
    * Multi-core main-memory databases

## Relation Schema and Instance

* A1, A2, …, An are attributes
* R = (A1, A2, …, An ) is a relation schema
  * Example: instructor = (ID, name, dept_name, salary)
* A relation instance r defined over schema R is denoted by r (R).
* The current values of a relation are specified by a table
* An element t of relation r is called a tuple and is represented by a row in a table

## Attributes

* The set of allowed values for each attribute is called the domain of the attribute
* Attribute values are (normally) required to be atomic; that is, indivisible
* The special value null is a member of every domain. Indicated that the value is “unknown” or “does not exist"
* The null value causes complications in the definition of many operations

## Relations are Unordered

* Order of tuples is irrelevant (tuples may be stored in an arbitrary order)

## Database Schema

* Database schema -- is the logical structure of the database.
  * Example: instructor (ID, name, dept_name, salary)
* Database instance -- is a snapshot of the data in the database at a given instant in time.

##  Keys

* Let K be a subset of R
* K is a superkey of R if values for K are sufficient to identify a unique tuple of each possible relation r(R)
  * Example: {ID} and {ID, name} are both superkeys of instructor.
* Superkey K is a candidate key if K is minimal
  * Example: {ID} is a candidate key for Instructor
* One of the candidate keys is selected to be the primary key.
  * Which one?
* Foreign key constraint: Value in one relation must appear in another
  * Referencing relation
  * Referenced relation
  * Example: dept_name in instructor is a foreign key from instructor referencing department

## Relational Query Languages

* A query language is a language in which a user requests information from the database.
* Can be categorized as imperative, functional , or declarative
  * Imperative – users instruct the system to perform a specific sequence of operations on the database to compute the desired results;
  * Functional – the computation is expressed as the evaluation of function that may operate on data in the database or on the results of other functions;
  * Declarative – the user describes the desired information without giving a specific sequence of steps or function calls for obtaining that information;
* The relational algebra is a functional query language and forms the theoretical basis of the SQL query language.

## Relational Algebra

* Relational Algebra is a functional language consisting of a set of operations that take one or two relations as input and produce a new relation as their result. 

* Basic operators:

| σ | Select |
| Π | Project |
| X | Cartesian Product |
| ⋈ | Join |
| ∪ | Union |
| ∩ | Intersection |
| – | Set Difference |
| ← | Assignment |
| ρ | Rename |

# 基础语句

## SELECT

> 从数据库中选取数据。

格式：

```sql
SELECT column_name,column_name 
FROM table_name;
```

实际运用：

```sql
SELECT * FROM section;
SELECT course_id FROM section;
SELECT course_id, room_number FROM section;
```

### DISTINCT

> 列出不重复的值。

```sql
SELECT DISTINCT * FROM section;
SELECT DISTINCT sec_id FROM section;
SELECT DISTINCT sec_id, building FROM section;
```

## WHERE

> 提取满足指定条件的记录。

格式：

```sql
SELECT column_name,column_name 
FROM table_name 
WHERE column_name operator value;
```

实际运用：

```sql
-- 文本须加引号，区分大小写。
SELECT * FROM section WHERE semester = 'Fall';
-- 错误的写法: SELECT * FROM section WHERE semester = Fall;

-- 数值可以加引号，最好不加。
SELECT * FROM section WHERE sec_id = 2;
SELECT * FROM section WHERE sec_id = '2';
```

### = 或 IS

```sql
SELECT * FROM section WHERE sec_id IS NULL;
```

### <> 或 !=

```sql
SELECT * FROM section WHERE sec_id <> 1;
```

### < ， > ， <= ， >=

```sql
SELECT * FROM time_slot WHERE start_hr > 13;
```

### BETWEEN ... AND ...

> 包含边界。

```sql
SELECT * FROM time_slot WHERE start_hr BETWEEN 13 AND 16;
```

### LIKE 加 % 或 \_

> % 表示多个字符，\_ 表示一个字符

```sql
SELECT * FROM instructor WHERE dept_name LIKE '%sic%';
SELECT * FROM instructor WHERE dept_name LIKE 'His%';
SELECT * FROM instructor WHERE dept_name LIKE '%o_y';
```

### IN()

> 和 OR 加 = 一个效果

```sql
SELECT * FROM instructor WHERE dept_name IN('Music', 'History');
SELECT * FROM instructor WHERE dept_name IS 'Music' OR dept_name IS 'History';
```

### () , NOT , AND , OR

> 优先级：() > NOT > AND > OR

```sql
SELECT * FROM instructor WHERE salary > 70000 AND NOT dept_name LIKE '%sic%';
```

## ORDER BY

> 排序。默认为正序ASC，DESC为倒序。只对其紧跟着的第一个列名有效，其他不受影响。

格式：

```sql
SELECT column_name,column_name
FROM table_name
ORDER BY column_name,column_name ASC|DESC;
```

实际运用：

```sql
SELECT * FROM time_slot;
SELECT * FROM time_slot ORDER BY start_hr DESC, day;
```

## INSERT INTO

> 向表中插入新记录。如果列出插入行的每一列数据，则不需要指定列名。

格式：

```sql
INSERT INTO table_name (column1,column2,column3,...)
VALUES (value1,value2,value3,...);
```

实际运用：

```sql
SELECT * FROM section;
INSERT INTO section (course_id, sec_id, semester, year, time_slot_id) VALUES ('BIO-201', 2, 'Fall', 2018, 'D');
SELECT * FROM section;
INSERT INTO section VALUES ('BIO-401', 2, 'Fall', 2018, 'Packard', 100, 'D');
SELECT * FROM section;
```

## UPDATE

> 更新表中已存在的记录。

格式：

```sql
UPDATE table_name
SET column1=value1,column2=value2,...
WHERE some_column=some_value;
```

实际运用：

```sql
SELECT * FROM section;
UPDATE section SET semester = 'Winter', time_slot_id = 'A' WHERE room_number = 101;
SELECT * FROM section;
```

> 如果省略 WHERE 子句，所有的记录都将被更新，因此一定要注意

```sql
SELECT * FROM section;
UPDATE section SET semester = 'Winter', time_slot_id = 'A';
SELECT * FROM section;
```

## DELETE

> 删除表中的记录

格式：

```sql
DELETE FROM table_name
WHERE some_column=some_value;
```

实际运用：

```sql
SELECT * FROM section;
DELETE FROM section WHERE semester = 'Fall';
SELECT * FROM section;
```

> 同样，如果省略 WHERE 子句，所有的记录都将被删除，因此一定要注意。<br>除此之外，删除操作无法撤销，也需要注意




